import { bot } from '../botInstance.js';
import { User } from '../../models/User.js';
import { refundRules } from '../rules/refundRules.js';

// –§–ª–∞–≥ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –¥—É–±–ª–∏—Ä–æ–≤–∞–Ω–∏—è –º–µ–Ω—é
const menuShown = new Set();

const menuController = {
    /**
     * –û—Ç–æ–±—Ä–∞–∂–∞–µ—Ç –≥–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é —Å –∏–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω—ã–º–∏ –∫–Ω–æ–ø–∫–∞–º–∏
     * @param {number} chatId - ID —á–∞—Ç–∞
     * @param {boolean} isAdmin - –§–ª–∞–≥ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞
     */
    showMainMenu: async (chatId, isAdmin = false) => {
        if (menuShown.has(chatId)) return;
        menuShown.add(chatId);

        try {
            const menuButtons = [
                [
                    { text: 'üçΩÔ∏è –ú–µ–Ω—é', web_app: { url: process.env.WEB_APP_URL_MENU } },
                    { text: 'üéØ –ë–∏–ª—å—è—Ä–¥', web_app: { url: process.env.WEB_APP_URL_BILLARD } },
                ],
                [
                    { text: 'üíø –î–∏—Å–∫–æ-–±–∞—Ä', web_app: { url: process.env.WEB_APP_URL_dISCO } },
                    { text: 'üé§ –ö–∞—Ä–∞–æ–∫–µ', web_app: { url: process.env.WEB_APP_URL_CARAOKE } }
                ],
                [
                    { text: 'üõãÔ∏è –õ–∞—É–Ω–∂ –∑–æ–Ω–∞', web_app: { url: process.env.WEB_APP_URL_LAUNZH } },
                    { text: 'üéÆ Playstation', web_app: { url: process.env.WEB_APP_URL_PLAYSTATIONS } }
                ],
                [
                    { text: 'üé≤ –ù–∞—Å—Ç–æ–ª—å–Ω—ã–µ –∏–≥—Ä—ã', web_app: { url: process.env.WEB_APP_URL_TABLEPLAY } },
                    { text: 'üìÖ –ê—Ñ–∏—à–∞', web_app: { url: process.env.WEB_APP_URL_AFISHA } },
                ],
                [
                    { text: 'üõéÔ∏è –ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ', web_app: { url: process.env.WEB_APP_URL_RESERVE } },
                    { text: 'üéüÔ∏è –ë–∏–ª–µ—Ç—ã', callback_data: 'show_tickets' }
                ],
                // –£—Ç–∏–ª–∏—Ç—ã
                [
                    { text: 'üí≥ –û–ø–ª–∞—Ç–∞', callback_data: 'pay' },
                    { text: 'üìû –ö–æ–Ω—Ç–∞–∫—Ç—ã', callback_data: 'contacts' }
                ],
                // –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                [
                    { text: 'üìù –ü—Ä–∞–≤–∏–ª–∞ –æ–ø–ª–∞—Ç—ã', callback_data: 'pay_rules' },
                    { text: '‚Ü©Ô∏è –ü—Ä–∞–≤–∏–ª–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞', callback_data: 'refund' }
                ]
            ];

            // –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å
            if (isAdmin) {
                menuButtons.push([
                    { text: 'üõ†Ô∏è –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –±–∏–ª–µ—Ç–∞–º–∏', callback_data: 'admin_tickets' },
                    { text: '‚öôÔ∏è –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å', callback_data: 'admin_panel' }
                ]);
            }

            await bot.sendMessage(chatId, 'üëá –í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª:', {
                reply_markup: { inline_keyboard: menuButtons }
            });

            setTimeout(() => menuShown.delete(chatId), 5000);
        } catch (error) {
            console.error('Menu display error:', error);
            menuShown.delete(chatId);
        }
    },

    /**
     * –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—É /start
     * @param {Object} msg - –û–±—ä–µ–∫—Ç —Å–æ–æ–±—â–µ–Ω–∏—è Telegram
     */
    handleStartCommand: async (msg) => {
        const chatId = msg.chat?.id;
        const user = msg.from;

        if (!chatId || !user?.id) {
            console.error('Invalid message structure:', msg);
            return bot.sendMessage(
                chatId || user?.id,
                '‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –≤–∞—à–µ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.'
            );
        }

        try {
            const result = await User.findOrCreateFromTelegram(user);
            if (!result?.user) throw new Error('User creation failed');

            const { user: dbUser, created } = result;
            console.log(`User ${created ? 'created' : 'updated'}:`, {
                id: dbUser.telegram_id,
                username: dbUser.username,
                first_name: dbUser.first_name
            });

            const welcomeText = `
            üé≠ ${created ? '–î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å' : '–° –≤–æ–∑–≤—Ä–∞—â–µ–Ω–∏–µ–º'}, ${dbUser.first_name} –≤ –†–∞–∑–≤–ª–µ–∫–∞—Ç–µ–ª—å–Ω—ã–π –∫–ª—É–± "–§—Ä–∞–Ω—Ü—É–∑"!

            ‚ú® ${created ? '–í—ã —É—Å–ø–µ—à–Ω–æ –∑–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞–Ω—ã!' : '–†–∞–¥—ã –≤–∏–¥–µ—Ç—å –≤–∞—Å —Å–Ω–æ–≤–∞!'}

            üéâ –í–∞—à –∏–¥–µ–∞–ª—å–Ω—ã–π –≤–µ—á–µ—Ä –Ω–∞—á–∏–Ω–∞–µ—Ç—Å—è –∑–¥–µ—Å—å:
            ‚Ä¢ üéØ –ë–∏–ª—å—è—Ä–¥ –¥–ª—è –∏—Å—Ç–∏–Ω–Ω—ã—Ö —Ü–µ–Ω–∏—Ç–µ–ª–µ–π
            ‚Ä¢ üé§ –ö–∞—Ä–∞–æ–∫–µ —Å –æ–±—à–∏—Ä–Ω–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–µ–π –ø–µ—Å–µ–Ω
            ‚Ä¢ üéÆ –ò–≥—Ä–æ–≤—ã–µ –ø—Ä–∏—Å—Ç–∞–≤–∫–∏ –¥–ª—è –¥—Ä—É–∂–µ—Å–∫–∏—Ö –±–∞—Ç–∞–ª–∏–π
            ‚Ä¢ üé≤ –ù–∞—Å—Ç–æ–ª—å–Ω—ã–µ –∏–≥—Ä—ã –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏ –ª—é–±–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
            ‚Ä¢ üíø –î–∏—Å–∫–æ-–±–∞—Ä —Å –ª—É—á—à–∏–º–∏ DJ
            ‚Ä¢ üõãÔ∏è –õ–∞—É–Ω–∂ –∑–æ–Ω–∞ –¥–ª—è —É—é—Ç–Ω—ã—Ö –ø–æ—Å–∏–¥–µ–ª–æ–∫
            ‚Ä¢ üçΩÔ∏è –ë–∞—Ä –∏ –∫—É—Ö–Ω—è —Å –∏–∑—ã—Å–∫–∞–Ω–Ω—ã–º–∏ –±–ª—é–¥–∞–º–∏

            üëá –í—ã–±–µ—Ä–∏—Ç–µ —Ä–∞–∑–¥–µ–ª, –∫–æ—Ç–æ—Ä—ã–π –≤–∞—Å –∏–Ω—Ç–µ—Ä–µ—Å—É–µ—Ç:
            `;

            await bot.sendMessage(chatId, welcomeText);
            await menuController.showMainMenu(chatId, dbUser.is_admin);

        } catch (error) {
            console.error('Start command error:', error);
            await bot.sendMessage(chatId, '‚ö†Ô∏è –ü—Ä–æ–∏–∑–æ—à–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ –∫–æ–º–∞–Ω–¥—ã. –ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –ø–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.');
        }
    },

    /**
     * –ù–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç –∫–æ–º–∞–Ω–¥—ã –±–æ—Ç–∞
     */
    setupBotCommands: () => {
        const commands = [
            { command: '/start', description: '–ù–∞—á–∞—Ç—å —Ä–∞–±–æ—Ç—É —Å –±–æ—Ç–æ–º' },
            { command: '/menu', description: '–ú–µ–Ω—é –±–∞—Ä–∞ –∏ –∫—É—Ö–Ω–∏' },
            { command: '/billiard', description: '–ë–∏–ª—å—è—Ä–¥' },
            { command: '/karaoke', description: '–ö–∞—Ä–∞–æ–∫–µ' },
            { command: '/disco', description: '–î–∏—Å–∫–æ-–±–∞—Ä' },
            { command: '/lounge', description: '–õ–∞—É–Ω–∂ –∑–æ–Ω–∞' },
            { command: '/playstation', description: '–ò–≥—Ä–æ–≤—ã–µ –ø—Ä–∏—Å—Ç–∞–≤–∫–∏' },
            { command: '/games', description: '–ù–∞—Å—Ç–æ–ª—å–Ω—ã–µ –∏–≥—Ä—ã' },
            { command: '/show_tickets', description: '–ö—É–ø–∏—Ç—å –±–∏–ª–µ—Ç—ã' },
            { command: '/events', description: '–ê—Ñ–∏—à–∞ –º–µ—Ä–æ–ø—Ä–∏—è—Ç–∏–π' },
            { command: '/pay', description: '–û–ø–ª–∞—Ç–∞' },
            { command: '/pay_rules', description: '–ü—Ä–∞–≤–∏–ª–∞ –æ–ø–ª–∞—Ç—ã' },
            { command: '/refund', description: '–ü—Ä–∞–≤–∏–ª–∞ –≤–æ–∑–≤—Ä–∞—Ç–∞' },
            { command: '/reserve', description: '–ë—Ä–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ' },
            { command: '/contacts', description: '–ö–æ–Ω—Ç–∞–∫—Ç—ã' }
        ];

        return bot.setMyCommands(commands)
            .then(() => console.log('–ö–æ–º–∞–Ω–¥–Ω–æ–µ –º–µ–Ω—é —É—Å–ø–µ—à–Ω–æ –Ω–∞—Å—Ç—Ä–æ–µ–Ω–æ'))
            .catch(err => {
                console.error('–û—à–∏–±–∫–∞ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∫–æ–º–∞–Ω–¥:', err);
                throw err;
            });
    }
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–æ–º–∞–Ω–¥ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ
menuController.setupBotCommands();

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º –∫–∞–∫ –∏–º–µ–Ω–æ–≤–∞–Ω–Ω—ã–µ —ç–∫—Å–ø–æ—Ä—Ç—ã –∏ default
export const { showMainMenu, handleStartCommand, setupBotCommands } = menuController;
export default menuController;